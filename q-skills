#!/bin/bash

# Skills directory is always at ~/.kiro/skills
SKILLS_DIR="$HOME/.kiro/skills"

extract_frontmatter() {
    local file="$1"
    local key="$2"
    
    if [ -f "$file" ]; then
        # Extract value from YAML frontmatter
        awk -v key="$key" '
        BEGIN { in_frontmatter=0; found=0 }
        /^---$/ { 
            if (in_frontmatter) exit
            in_frontmatter=1; next 
        }
        in_frontmatter && $0 ~ "^" key ":" { 
            gsub("^" key ":[[:space:]]*", "")
            gsub("\"", "")
            print $0
            found=1
        }
        ' "$file"
    fi
}

list_skills() {
    local skills_to_show=("$@")
    
    if [ ${#skills_to_show[@]} -eq 0 ]; then
        # No filter - show all skills
        for skill_dir in "$SKILLS_DIR"/*; do
            if [ -d "$skill_dir" ] && [ -f "$skill_dir/SKILL.md" ]; then
                skills_to_show+=($(basename "$skill_dir"))
            fi
        done
    fi
    
    for skill in "${skills_to_show[@]}"; do
        skill_dir="$SKILLS_DIR/$skill"
        if [ -d "$skill_dir" ] && [ -f "$skill_dir/SKILL.md" ]; then
            description=$(extract_frontmatter "$skill_dir/SKILL.md" "description")
            when_to_use=$(extract_frontmatter "$skill_dir/SKILL.md" "when_to_use")
            
            echo "$skill"
            [ -n "$description" ] && echo "  $description"
            [ -n "$when_to_use" ] && echo "  When to use: $when_to_use"
            echo ""
        fi
    done
}

case "$1" in
    "list")
        if [ "$2" = "--skills" ] && [ -n "$3" ]; then
            echo "Available Agent Skills:"
            echo "======================"
            echo ""
            
            # Parse comma-separated skills list
            IFS=',' read -ra SKILL_ARRAY <<< "$3"
            list_skills "${SKILL_ARRAY[@]}"
        else
            echo "Available Q CLI Skills:"
            echo "======================"
            echo ""
            
            if [ ! -d "$SKILLS_DIR" ]; then
                echo "No skills directory found at $SKILLS_DIR"
                exit 0
            fi
            
            list_skills
        fi
        
        echo "Usage: q-skills use <skill-name> to load a skill"
        ;;
        
    "use")
        skill_name="$2"
        if [ -z "$skill_name" ]; then
            echo "Usage: q-skills use <skill-name>"
            exit 1
        fi
        
        skill_file="$SKILLS_DIR/$skill_name/SKILL.md"
        if [ -f "$skill_file" ]; then
            echo "# Loading skill: $skill_name"
            echo "# ================================"
            echo ""
            
            # Skip frontmatter and show content
            awk '
            BEGIN { in_frontmatter=0; frontmatter_ended=0 }
            /^---$/ { 
                if (in_frontmatter) { frontmatter_ended=1; next }
                in_frontmatter=1; next 
            }
            frontmatter_ended || !in_frontmatter { print }
            ' "$skill_file"
        else
            echo "Skill not found: $skill_name"
            echo ""
            echo "Available skills:"
            "$0" list
        fi
        ;;
        
    *)
        echo "Q CLI Skills Manager"
        echo "Usage:"
        echo "  q-skills list           # List all available skills"
        echo "  q-skills use <name>     # Load and display a specific skill"
        echo ""
        echo "Skills are stored in: $SKILLS_DIR"
        ;;
esac
